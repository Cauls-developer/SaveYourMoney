<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Relatórios</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <h2>Relatórios</h2>
        <p>Gere o relatório mensal em PDF com um clique.</p>
      </div>
    </header>

    <div class="card report-export-card">
      <div class="report-export-page">
        <p class="muted">O relatório será gerado para o mês atual.</p>
        <button id="export-pdf" class="button report-export-button" type="button">Gerar relatório em PDF</button>
        <p id="report-feedback" class="report-feedback muted" role="status" aria-live="polite"></p>
        <div id="report-filters-placeholder" class="report-filters-placeholder" hidden aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <script src="navigation.js"></script>
  <script>
    const exportPdf = document.getElementById('export-pdf');
    const reportFeedback = document.getElementById('report-feedback');

    function setFeedback(message, statusClass) {
      reportFeedback.textContent = message;
      reportFeedback.classList.remove('success', 'error');
      if (statusClass) reportFeedback.classList.add(statusClass);
    }

    async function downloadPdf(month, year) {
      const url = `http://localhost:5000/relatorios/mes/pdf?mes=${month}&ano=${year}`;
      const response = await fetch(url);
      if (!response.ok) {
        let message = `Falha ao exportar PDF (${response.status}).`;
        try {
          const payload = await response.json();
          message = payload.error || payload.message || message;
        } catch {
          const text = (await response.text()).trim();
          if (text && !text.startsWith('<')) message = text;
        }
        throw new Error(message);
      }

      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = objectUrl;
      link.download = `relatorio_${String(month).padStart(2, '0')}_${year}.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(objectUrl);
    }

    exportPdf.addEventListener('click', async () => {
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();

      exportPdf.disabled = true;
      exportPdf.classList.add('is-loading');
      setFeedback('Gerando PDF...', null);

      try {
        await downloadPdf(month, year);
        setFeedback('PDF gerado com sucesso.', 'success');
      } catch (error) {
        setFeedback(error.message || 'Erro ao gerar PDF.', 'error');
      } finally {
        exportPdf.disabled = false;
        exportPdf.classList.remove('is-loading');
      }
    });
  </script>
  <script src="calculator-widget.js"></script>
</body>
</html>
