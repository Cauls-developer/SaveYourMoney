<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Relatórios</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <h2>Relatórios</h2>
        <p>Fatura mensal consolidada com visão analítica.</p>
      </div>
      <div class="navbar">
        <div class="logo">
          <img src="../assets/logo.png" alt="Save Your Money" class="logo-image" />
          <span>Save Your Money</span>
        </div>
        <button id="nav-toggle" class="nav-toggle">Menu</button>
        <nav class="app-nav">
          <a href="dashboard.html">Dashboard</a>
          <a href="expenses.html">Gastos</a>
          <a href="incomes.html">Entradas</a>
          <a href="banks.html">Bancos</a>
          <a class="active" href="reports.html">Relatórios</a>
          <a href="goals.html">Metas</a>
          <a href="settings.html">Configurações</a>
        </nav>
      </div>
    </header>

    <section class="section-title">Selecionar período</section>
    <div class="card">
      <form id="report-form" class="app-form">
        <div class="field">
          <label for="report-month">Mês</label>
          <input id="report-month" type="number" min="1" max="12" />
        </div>
        <div class="field">
          <label for="report-year">Ano</label>
          <input id="report-year" type="number" min="2000" />
        </div>
        <button type="submit" class="button">Gerar relatório</button>
      </form>
      <div class="section-title">Exportar</div>
      <div class="grid">
        <button id="export-csv" class="button ghost">Baixar CSV</button>
        <button id="export-pdf" class="button ghost">Baixar PDF</button>
      </div>
    </div>

    <section class="section-title">Resumo do mês</section>
    <div class="grid cols-3 report-summary">
      <div class="card report-card">
        <span class="metric-label">Total de Gastos</span>
        <div id="report-expenses" class="metric-value">R$ 0,00</div>
      </div>
      <div class="card report-card">
        <span class="metric-label">Total de Entradas</span>
        <div id="report-incomes" class="metric-value">R$ 0,00</div>
      </div>
      <div class="card report-card">
        <span class="metric-label">Saldo</span>
        <div id="report-balance" class="metric-value">R$ 0,00</div>
      </div>
    </div>

    <section class="section-title">Analise visual</section>
    <div class="split">
      <div class="card">
        <h3>Distribuicao por categoria</h3>
        <canvas id="category-chart" class="report-chart" width="420" height="260"></canvas>
      </div>
      <div class="card">
        <h3>Entradas vs Saidas</h3>
        <canvas id="flow-chart" class="report-chart" width="420" height="260"></canvas>
      </div>
    </div>

    <section class="section-title">Gastos por categoria</section>
    <ul id="report-categories" class="list"></ul>

    <section class="section-title">Gastos detalhados do mes</section>
    <ul id="report-expense-list" class="list"></ul>

    <section class="section-title">Entradas detalhadas do mes</section>
    <ul id="report-income-list" class="list"></ul>

    <section class="section-title">Metas do mês</section>
    <ul id="report-goals" class="list"></ul>
  </div>

  <script src="navigation.js"></script>
  <script>
    const form = document.getElementById('report-form');
    const reportExpenses = document.getElementById('report-expenses');
    const reportIncomes = document.getElementById('report-incomes');
    const reportBalance = document.getElementById('report-balance');
    const reportCategories = document.getElementById('report-categories');
    const reportGoals = document.getElementById('report-goals');
    const reportExpenseList = document.getElementById('report-expense-list');
    const reportIncomeList = document.getElementById('report-income-list');
    const categoryChart = document.getElementById('category-chart');
    const flowChart = document.getElementById('flow-chart');
    const exportCsv = document.getElementById('export-csv');
    const exportPdf = document.getElementById('export-pdf');
    const chartPalette = ['#910142', '#0ec0c1', '#6c043c', '#b83a6f', '#106365', '#c07894', '#755a66'];

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast${isError ? ' error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    function formatMonthYear(month, year) {
      const date = new Date(year, month - 1, 1);
      return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    }

    function formatDate(day, month, year) {
      if (!day) return `${String(month).padStart(2, '0')}/${year}`;
      return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
    }

    function renderCategoryList(byCategory) {
      reportCategories.replaceChildren();
      const entries = Object.entries(byCategory || {});
      if (!entries.length) {
        const item = document.createElement('li');
        item.innerHTML = '<small class="muted">Sem gastos por categoria no periodo.</small>';
        reportCategories.appendChild(item);
        return;
      }
      entries
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, value]) => {
          const item = document.createElement('li');
          const info = document.createElement('div');
          info.className = 'stack-1';
          const title = document.createElement('strong');
          title.textContent = name;
          const detail = document.createElement('small');
          detail.textContent = 'Gasto por categoria';
          info.appendChild(title);
          info.appendChild(detail);
          const amount = document.createElement('strong');
          amount.textContent = formatCurrency(value);
          item.appendChild(info);
          item.appendChild(amount);
          reportCategories.appendChild(item);
        });
    }

    function renderExpenseDetails(expenses, month, year) {
      reportExpenseList.replaceChildren();
      if (!expenses.length) {
        const item = document.createElement('li');
        item.innerHTML = '<small class="muted">Nenhum gasto no periodo selecionado.</small>';
        reportExpenseList.appendChild(item);
        return;
      }

      expenses
        .slice()
        .sort((a, b) => Number(b.day || 0) - Number(a.day || 0))
        .forEach((expense) => {
          const item = document.createElement('li');
          const info = document.createElement('div');
          info.className = 'stack-1';

          const title = document.createElement('strong');
          title.textContent = expense.name || 'Gasto';
          const detail = document.createElement('small');
          detail.textContent = `${expense.category || 'Sem categoria'} - ${formatDate(expense.day, month, year)}`;

          info.appendChild(title);
          info.appendChild(detail);

          const amount = document.createElement('strong');
          amount.textContent = formatCurrency(expense.value || 0);

          item.appendChild(info);
          item.appendChild(amount);
          reportExpenseList.appendChild(item);
        });
    }

    function renderIncomeDetails(incomes, month, year) {
      reportIncomeList.replaceChildren();
      if (!incomes.length) {
        const item = document.createElement('li');
        item.innerHTML = '<small class="muted">Nenhuma entrada no periodo selecionado.</small>';
        reportIncomeList.appendChild(item);
        return;
      }

      incomes
        .slice()
        .sort((a, b) => Number(b.day || 0) - Number(a.day || 0))
        .forEach((income) => {
          const item = document.createElement('li');
          const info = document.createElement('div');
          info.className = 'stack-1';

          const title = document.createElement('strong');
          title.textContent = income.name || 'Entrada';
          const detail = document.createElement('small');
          const status = income.confirmed ? 'Confirmada' : 'Prevista';
          detail.textContent = `${status} - ${formatDate(income.day, month, year)}`;

          info.appendChild(title);
          info.appendChild(detail);

          const amount = document.createElement('strong');
          amount.textContent = formatCurrency(income.value || 0);

          item.appendChild(info);
          item.appendChild(amount);
          reportIncomeList.appendChild(item);
        });
    }

    function drawPieChart(canvas, valuesByCategory) {
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      const entries = Object.entries(valuesByCategory || {}).filter(([, value]) => Number(value) > 0);
      if (!entries.length) {
        context.fillStyle = '#6f5d6a';
        context.font = '600 14px Manrope';
        context.fillText('Sem dados para o grafico.', 20, 36);
        return;
      }

      const total = entries.reduce((sum, [, value]) => sum + Number(value), 0);
      const cx = 125;
      const cy = 130;
      const radius = 88;
      let startAngle = -Math.PI / 2;

      entries.forEach(([name, value], index) => {
        const sliceValue = Number(value);
        const sliceAngle = (sliceValue / total) * Math.PI * 2;
        context.beginPath();
        context.moveTo(cx, cy);
        context.fillStyle = chartPalette[index % chartPalette.length];
        context.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
        context.closePath();
        context.fill();
        startAngle += sliceAngle;

        const legendY = 28 + index * 22;
        context.fillRect(250, legendY - 10, 12, 12);
        context.fillStyle = '#2f1427';
        context.font = '600 12px Manrope';
        context.fillText(`${name} (${((sliceValue / total) * 100).toFixed(1)}%)`, 268, legendY);
      });
    }

    function drawFlowChart(canvas, totalIncomes, totalExpenses) {
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);

      const values = [Number(totalIncomes || 0), Number(totalExpenses || 0)];
      const maxValue = Math.max(...values, 1);
      const baselineY = 220;
      const barWidth = 120;
      const xStart = 70;
      const gap = 95;

      context.strokeStyle = 'rgba(108, 4, 60, 0.2)';
      context.beginPath();
      context.moveTo(40, baselineY);
      context.lineTo(380, baselineY);
      context.stroke();

      const labels = ['Entradas', 'Saidas'];
      const colors = ['#0ec0c1', '#910142'];
      values.forEach((value, index) => {
        const x = xStart + index * (barWidth + gap);
        const height = (value / maxValue) * 150;
        const y = baselineY - height;
        context.fillStyle = colors[index];
        context.fillRect(x, y, barWidth, height);
        context.fillStyle = '#2f1427';
        context.font = '700 12px Manrope';
        context.fillText(labels[index], x + 24, baselineY + 22);
        context.fillText(formatCurrency(value), x + 8, y - 8);
      });
    }

    function renderGoals(goals) {
      reportGoals.replaceChildren();
      (goals || []).forEach((goal) => {
        const ok = goal.remaining >= 0;
        const status = ok ? 'Dentro do limite' : 'Estourou';
        const item = document.createElement('li');
        const summary = document.createElement('div');
        summary.className = 'stack-1';
        const title = document.createElement('strong');
        title.textContent = goal.name;
        const detail = document.createElement('small');
        detail.textContent = `${formatCurrency(goal.spent)} / ${formatCurrency(goal.limit_value)}`;
        summary.appendChild(title);
        summary.appendChild(detail);
        const pill = document.createElement('span');
        pill.className = `pill ${ok ? 'ok' : 'alert'}`;
        pill.textContent = status;
        item.appendChild(summary);
        item.appendChild(pill);
        reportGoals.appendChild(item);
      });
    }

    function renderReport(report, expenses, incomes, month, year) {
      reportExpenses.textContent = formatCurrency(report.total_expenses);
      reportIncomes.textContent = formatCurrency(report.total_incomes);
      reportBalance.textContent = formatCurrency(report.balance);
      renderCategoryList(report.by_category || {});
      renderExpenseDetails(expenses, month, year);
      renderIncomeDetails(incomes, month, year);
      renderGoals(report.goals || []);
      drawPieChart(categoryChart, report.by_category || {});
      drawFlowChart(flowChart, report.total_incomes, report.total_expenses);

      const periodText = formatMonthYear(month, year);
      reportExpenses.closest('.card').querySelector('.metric-label').textContent = `Total de gastos - ${periodText}`;
      reportIncomes.closest('.card').querySelector('.metric-label').textContent = `Total de entradas - ${periodText}`;
      reportBalance.closest('.card').querySelector('.metric-label').textContent = `Saldo liquido - ${periodText}`;
    }

    async function loadReport(month, year) {
      const [report, expenses, incomes] = await Promise.all([
        window.api.getMonthlyReport(month, year),
        window.api.listExpenses(month, year),
        window.api.listIncomes(month, year),
      ]);
      renderReport(report, expenses, incomes, month, year);
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const month = Number(document.getElementById('report-month').value);
      const year = Number(document.getElementById('report-year').value);
      try {
        await loadReport(month, year);
      } catch (error) {
        showToast(error.message, true);
      }
    });

    const now = new Date();
    document.getElementById('report-month').value = now.getMonth() + 1;
    document.getElementById('report-year').value = now.getFullYear();
    loadReport(now.getMonth() + 1, now.getFullYear()).catch(console.error);

    function getSelectedPeriod() {
      const month = Number(document.getElementById('report-month').value);
      const year = Number(document.getElementById('report-year').value);
      return { month, year };
    }

    exportCsv.addEventListener('click', () => {
      const { month, year } = getSelectedPeriod();
      window.open(`http://localhost:5000/relatorios/mes/csv?mes=${month}&ano=${year}`);
    });

    exportPdf.addEventListener('click', () => {
      const { month, year } = getSelectedPeriod();
      window.open(`http://localhost:5000/relatorios/mes/pdf?mes=${month}&ano=${year}`);
    });

  </script>
  <script src="calculator-widget.js"></script>
</body>
</html>






