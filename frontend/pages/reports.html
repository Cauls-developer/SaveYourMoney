<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Relatórios</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <h2>Relatórios</h2>
        <p>Visão consolidada do mês.</p>
      </div>
      <div class="navbar">
        <div class="logo">
          <img src="../assets/logo.png" alt="Save Your Money" class="logo-image" />
          <span>Save Your Money</span>
        </div>
        <button id="nav-toggle" class="nav-toggle">Menu</button>
        <nav class="app-nav">
          <a href="dashboard.html">Dashboard</a>
          <a href="expenses.html">Gastos</a>
          <a href="incomes.html">Entradas</a>
          <a href="banks.html">Bancos</a>
          <a class="active" href="reports.html">Relatórios</a>
          <a href="goals.html">Metas</a>
          <a href="settings.html">Configurações</a>
        </nav>
      </div>
    </header>

    <section class="section-title">Selecionar período</section>
    <div class="card">
      <form id="report-form" class="app-form">
        <div class="field">
          <label for="report-month">Mês</label>
          <input id="report-month" type="number" min="1" max="12" />
        </div>
        <div class="field">
          <label for="report-year">Ano</label>
          <input id="report-year" type="number" min="2000" />
        </div>
        <button type="submit" class="button">Gerar relatório</button>
      </form>
      <div class="section-title">Exportar</div>
      <div class="grid">
        <button id="export-csv" class="button ghost">Baixar CSV</button>
        <button id="export-pdf" class="button ghost">Baixar PDF</button>
      </div>
    </div>

    <section class="section-title">Resumo do mês</section>
    <div class="grid cols-3 report-summary">
      <div class="card report-card">
        <span class="metric-label">Total de Gastos</span>
        <div id="report-expenses" class="metric-value">R$ 0,00</div>
      </div>
      <div class="card report-card">
        <span class="metric-label">Total de Entradas</span>
        <div id="report-incomes" class="metric-value">R$ 0,00</div>
      </div>
      <div class="card report-card">
        <span class="metric-label">Saldo</span>
        <div id="report-balance" class="metric-value">R$ 0,00</div>
      </div>
    </div>

    <section class="section-title">Gastos por categoria</section>
    <ul id="report-categories" class="list"></ul>

    <section class="section-title">Metas do mês</section>
    <ul id="report-goals" class="list"></ul>
  </div>

  <script>
    const form = document.getElementById('report-form');
    const reportExpenses = document.getElementById('report-expenses');
    const reportIncomes = document.getElementById('report-incomes');
    const reportBalance = document.getElementById('report-balance');
    const reportCategories = document.getElementById('report-categories');
    const reportGoals = document.getElementById('report-goals');
    const exportCsv = document.getElementById('export-csv');
    const exportPdf = document.getElementById('export-pdf');

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast${isError ? ' error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    function renderReport(report) {
      reportExpenses.textContent = formatCurrency(report.total_expenses);
      reportIncomes.textContent = formatCurrency(report.total_incomes);
      reportBalance.textContent = formatCurrency(report.balance);
      reportCategories.replaceChildren();
      Object.entries(report.by_category || {}).forEach(([name, value]) => {
        const item = document.createElement('li');
        const info = document.createElement('div');
        info.className = 'stack-1';
        const title = document.createElement('strong');
        title.textContent = name;
        const detail = document.createElement('small');
        detail.textContent = 'Gasto por categoria';
        info.appendChild(title);
        info.appendChild(detail);
        const amount = document.createElement('strong');
        amount.textContent = formatCurrency(value);
        item.appendChild(info);
        item.appendChild(amount);
        reportCategories.appendChild(item);
      });
      reportGoals.replaceChildren();
      (report.goals || []).forEach((goal) => {
        const ok = goal.remaining >= 0;
        const status = ok ? 'Dentro do limite' : 'Estourou';
        const item = document.createElement('li');
        const summary = document.createElement('div');
        summary.className = 'stack-1';
        const title = document.createElement('strong');
        title.textContent = goal.name;
        const detail = document.createElement('small');
        detail.textContent = `${formatCurrency(goal.spent)} / ${formatCurrency(goal.limit_value)}`;
        summary.appendChild(title);
        summary.appendChild(detail);
        const pill = document.createElement('span');
        pill.className = `pill ${ok ? 'ok' : 'alert'}`;
        pill.textContent = status;
        item.appendChild(summary);
        item.appendChild(pill);
        reportGoals.appendChild(item);
      });
    }

    async function loadReport(month, year) {
      const report = await window.api.getMonthlyReport(month, year);
      renderReport(report);
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const month = Number(document.getElementById('report-month').value);
      const year = Number(document.getElementById('report-year').value);
      try {
        await loadReport(month, year);
      } catch (error) {
        showToast(error.message, true);
      }
    });

    const now = new Date();
    document.getElementById('report-month').value = now.getMonth() + 1;
    document.getElementById('report-year').value = now.getFullYear();
    loadReport(now.getMonth() + 1, now.getFullYear()).catch(console.error);

    function getSelectedPeriod() {
      const month = Number(document.getElementById('report-month').value);
      const year = Number(document.getElementById('report-year').value);
      return { month, year };
    }

    exportCsv.addEventListener('click', () => {
      const { month, year } = getSelectedPeriod();
      window.open(`http://localhost:5000/relatorios/mes/csv?mes=${month}&ano=${year}`);
    });

    exportPdf.addEventListener('click', () => {
      const { month, year } = getSelectedPeriod();
      window.open(`http://localhost:5000/relatorios/mes/pdf?mes=${month}&ano=${year}`);
    });

    const navToggle = document.getElementById('nav-toggle');
    if (navToggle) {
      navToggle.addEventListener('click', () => document.body.classList.toggle('nav-open'));
    }
  </script>
  <script src="calculator-widget.js"></script>
</body>
</html>






